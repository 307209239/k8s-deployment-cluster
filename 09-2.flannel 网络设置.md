#### 网络组件安装之Fannel

---

#### 下载 flannel yaml 文件
```
$ wget https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml

```
#### 修改其中内容
```
$ vim kube-flannel.yml
  net-conf.json: |
    {
      "Network": "10.244.0.0/16",　--->  "Network": "172.30.0.0/16",
      "Backend": {
        "Type": "vxlan"
      }
    }
```
#### 部署 flannel 网络
```
$ kubectl apply -f ./kube-flannel.yml
```
#### 删除默认cni配置
```
$ export NODE_IPS=(192.168.133.128 192.168.133.129 192.168.133.130 192.168.133.131)
$ for node_ip in ${NODE_IPS[@]}
  do
    echo ">>> ${node_ip}"
    ssh ${node_ip} "rm -rf /etc/cni/net.d/10-default.conf"
    ssh ${node_ip} "systemctl restart kubelet"
  done
```
#### 测试网络
```
### 启动相关容器pod验证网络服务
```
cat > nginx-ds.yml <<EOF
apiVersion: v1
kind: Service
metadata:
  name: nginx-ds
  labels:
    app: nginx-ds
spec:
  type: NodePort
  selector:
    app: nginx-ds
  ports:
  - name: http
    port: 80
    targetPort: 80
---
apiVersion: extensions/v1beta1
kind: DaemonSet
metadata:
  name: nginx-ds
  labels:
    addonmanager.kubernetes.io/mode: Reconcile
spec:
  template:
    metadata:
      labels:
        app: nginx-ds
    spec:
      containers:
      - name: my-nginx
        image: nginx:1.7.9
        ports:
        - containerPort: 80
EOF

kubectl create -f nginx-ds.yml

kubectl get pods  -o wide|grep nginx-ds
```
#### 检查Node与Pod IP连通性
```
$ kubectl get pods  -o wide|grep nginx-ds
nginx-ds-4zknf   1/1       Running   0          17m       172.30.176.2     k8s-m01   <none>
nginx-ds-h2kqq   1/1       Running   0          17m       172.30.217.3     k8s-m02   <none>
nginx-ds-msb2f   1/1       Running   0          17m       172.30.181.193   k8s-n01   <none>
nginx-ds-qrbhg   1/1       Running   0          17m       172.30.57.65     k8s-n02   <none>
nginx-ds-vzb4t   1/1       Running   0          17m       172.30.205.132   k8s-m03   <none>
```
#### ping 每个节点上运行的Pod
```
NODE_IPS=(192.168.133.128 192.168.133.129 192.168.133.130 192.168.133.131 192.168.133.132)
for node_ip in ${NODE_IPS[@]}
  do
    echo ">>> ${node_ip}"
    ssh ${node_ip} "ping -c 4 172.30.176.2"
    ssh ${node_ip} "ping -c 4 172.30.217.3"
    ssh ${node_ip} "ping -c 4 172.30.181.193"
    ssh ${node_ip} "ping -c 4 172.30.57.65"
    ssh ${node_ip} "ping -c 4 172.30.205.132"
  done
```
#### 检查Service IP 和 端口可达性
```
NODE_IPS=(192.168.133.128 192.168.133.129 192.168.133.130 192.168.133.131 192.168.133.132)
for node_ip in ${NODE_IPS[@]}
  do
    echo ">>> ${node_ip}"
    ssh ${node_ip} "curl 10.254.42.186"
  done
```
### 查看etcd中calico相关信息
因为这里calico网络使用etcd存储数据，所以可以在etcd集群中查看数据

calico 3.x 版本默认使用 etcd v3存储，登陆集群的一个etcd 节点，查看命令：
查看所有calico相关数据
```
ETCDCTL_API=3 
etcdctl --cacert=/etc/kubernetes/ssl/ca.pem --cert=/etc/etcd/ssl/etcd.pem --key=/etc/etcd/ssl/etcd-key.pem --endpoints="https://192.168.133.128:2379,https://192.168.133.129:2379,https://192.168.133.130:2379" get --prefix /calico
```
查看 calico网络为各节点分配的网段
```
ETCDCTL_API=3 
etcdctl --cacert=/etc/kubernetes/ssl/ca.pem --cert=/etc/etcd/ssl/etcd.pem --key=/etc/etcd/ssl/etcd-key.pem --endpoints="https://192.168.133.128:2379,https://192.168.133.129:2379,https://192.168.133.130:2379" get --prefix /calico/ipam/v2/host
```
